# Безопасность

Реализация собственной системы безопасности - одна из спорных и неоднозначных особенностей в Ruby.

Безопасность кода в Ruby обеспечивается с помощью применения различных модификаторов, запрещающих изменение значения объекта или маркирующих небезопасные данные.

Интерпретатор автоматически считает небезопасными:

+ аргументы, переданные при запуске программы (элементы массива ARGV);
+ переменные окружения (элементы массива ENV);
+ любые данные, извлекаемые из файлов, сокетов или потоков;
+ объекты, создаваемые на основе небезопасных данных.

`$SAFE` ссылается на значение текущего уровня безопасности. Переменная локальна для каждого отдельного блока кода или процесса. Уровень безопасности основного процесса объявляется при запуске программы с помощью ключа `-T` (по умолчанию - 0).

Нарушение ограничений безопасности считается исключением `SecurityError`.

## Уровни безопасности

Более высокие уровни безопасности наследуют ограничения более низких.

### Уровень 0

Не предполагает ограничений.

### Уровень 1

Запрещается:

+ загружать библиотеки, если их название небезопасно;
+ выполнять произвольный код, если текст кода небезопасен;
+ открывать файлы, если их название небезопасно;
+ соединяться с хостом, если его название небезопасно;
+ запускать программу с ключами `-e, -i, -l, -r, -s, -S, -X`;
+ выполнять методы из классов Dir, IO, File, FileTest, передавая им небезопасные аргументы;
+ выполнять методы `test`, `eval`, `require`, `load`, `trap`, передавая им небезопасные аргументы.

Также игнорируются переменные окружения RUBYLIB и RUBYOPT и текущий каталог при поиске подключаемых библиотек.

### Уровень 2

Запрещается выполнять методы

+ `fork`
+ `syscall`
+ `exit!`
+ `Process.equid=`
+ `Process.fork`
+ `Process.setpgid`
+ `Process.setsid`
+ `Process.kill`
+ `Process.seeprioprity`

передавая им небезопасные аргументы.

### Уровень 3

Все объекты, кроме предопределенных считаются небезопасными. Вызов метода `.untaint` запрещается.

### Уровень 4

Запрещается:

+ изменять значение безопасных объектов;
+ загружать библиотеки с помощью `require` или `load` (разрешается в теле анонимного модуля);
+ использовать метапрограммирование;
+ работать с любыми процессами кроме текущего;
+ завершать выполнение процесса;
+ читать или записывать данные;
+ изменять переменные окружения;
+ вызывать методы `.srand` и `Random.srand.

Разрешается вызывать метод `.eval`, передавая ему небезопасные аргументы.

## Модификаторы

Модификаторы в данном случае объявляются с помощью методов.

`.freeze # -> self`

Запрещает изменять значение объекта.

`.frozen? # -> bool`

Проверка запрещено ли изменять значение объекта.

`.taint # -> self`

Используется для маркировки небезопасных данных. Этим модификатором отмечаются полученные внешние данные.

`.untaint # -> self`

Используется для маркировки безопасных данных.

`.tainted? # -> bool`

Проверка безопасно ли использование объекта.

`.untrust # -> self`

Используется для маркировки данных, которым разработчик не доверяет. Этим модификатором отмечаются данные, полученные при выполнении кода с уровнем безопасности 4.

`.trust # -> self`

Используется для маркировки данных, которым разработчик доверяет.

`.untrusted? # -> bool`

Проверка доверяет ли разработчик объекту.